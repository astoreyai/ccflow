# ccflow

> Claude Code CLI Middleware - Production Python SDK for Claude Code CLI

ccflow bridges the Claude Code CLI with SDK-like Python interfaces, enabling subscription-based usage (Pro/Max) with TOON token optimization (30-60% savings).

## Quick Facts

- **Version**: 0.1.0
- **Python**: 3.11+
- **License**: MIT
- **Auth**: Uses Claude subscription via CLI OAuth (no API keys needed)
- **Async**: Fully async/await throughout
- **Tests**: 855+ tests, 85% coverage
- **Modules**: 30 source files, 12K LOC

## Installation

```bash
pip install ccflow                    # Basic
pip install "ccflow[toon]"           # With TOON encoding
pip install "ccflow[all]"            # All extras
```

## Core API

### Simple Query
```python
from ccflow import query_simple
response = await query_simple("What is 2+2?")
```

### Streaming Query
```python
from ccflow import query, CLIAgentOptions, TextMessage

async for msg in query("Explain AI", CLIAgentOptions(model="sonnet")):
    if isinstance(msg, TextMessage):
        print(msg.content, end="")
```

### Multi-turn Session
```python
from ccflow import Session, CLIAgentOptions

session = Session(options=CLIAgentOptions(model="opus"))
async for msg in session.send_message("Hello!"):
    print(msg.content, end="")
async for msg in session.send_message("What did I say?"):
    print(msg.content, end="")  # Claude remembers
stats = await session.close()
print(f"Total tokens: {stats.total_tokens}")
```

### Batch Processing
```python
from ccflow import batch_query, CLIAgentOptions
results = await batch_query(["Q1", "Q2", "Q3"], CLIAgentOptions(), concurrency=3)
```

### Extended Thinking (Ultrathink)
```python
from ccflow import query, CLIAgentOptions, ThinkingMessage, TextMessage

options = CLIAgentOptions(model="sonnet", ultrathink=True)
async for msg in query("Analyze this complex algorithm", options):
    if isinstance(msg, ThinkingMessage):
        print(f"[Thinking: {msg.thinking_tokens} tokens]")
    elif isinstance(msg, TextMessage):
        print(msg.content, end="")
```

### Project & Trace Recording
```python
from ccflow import Project, CLIAgentOptions
from ccflow.stores import SQLiteProjectStore, SQLiteTraceStore, SQLiteSessionStore

# Initialize stores
db_path = "ccflow.db"
project = Project(
    name="Code Review",
    store=SQLiteProjectStore(db_path),
    trace_store=SQLiteTraceStore(db_path),
    session_store=SQLiteSessionStore(db_path),
)
await project.save()

# Create traced session
session = project.create_session(
    options=CLIAgentOptions(model="sonnet", ultrathink=True),
    detailed=True,  # Capture message-level stream
)

async for msg in session.send_message("Analyze this function"):
    print(msg.content, end="")

# Access trace
trace = session.last_trace
print(f"Thinking tokens: {trace.thinking_tokens}")
print(f"Tool calls: {len(trace.tool_calls)}")

# Replay with different model
new_session = await project.replay_as_new(
    trace.trace_id,
    options_override=CLIAgentOptions(model="opus"),
)
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  query() batch_query() Session Project TracingSession       │
├─────────────────────────────────────────────────────────────┤
│                    Middleware Layer                          │
│  SessionManager, StreamParser, EventEmitter, CostTracker    │
├─────────────────────────────────────────────────────────────┤
│                    Reliability Layer                         │
│  CircuitBreaker, RateLimiter, RetryHandler, HealthChecker   │
├─────────────────────────────────────────────────────────────┤
│                    Persistence Layer                         │
│  SQLiteSessionStore, SQLiteTraceStore, SQLiteProjectStore   │
├─────────────────────────────────────────────────────────────┤
│                    Execution Layer                           │
│  CLIExecutor, ProcessPool, StreamingPool                    │
├─────────────────────────────────────────────────────────────┤
│                    Infrastructure                            │
│  Claude CLI (subprocess with NDJSON streaming)              │
└─────────────────────────────────────────────────────────────┘
```

## Module Map

### Core API (src/ccflow/)
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `api.py` | High-level query functions | `query()`, `batch_query()`, `query_simple()` |
| `session.py` | Multi-turn conversations | `Session`, `load_session()`, `resume_session()` |
| `manager.py` | Session lifecycle | `SessionManager`, `get_manager()` |
| `executor.py` | CLI subprocess handling | `CLIExecutor`, `get_executor()` |
| `parser.py` | NDJSON stream parsing | `StreamParser`, `collect_text()`, `collect_thinking()` |

### Types & Configuration
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `types.py` | Type definitions (50+) | `CLIAgentOptions`, `Message`, `TraceData`, `ProjectData` |
| `config.py` | Environment settings | `CCFlowSettings`, `get_settings()` |
| `exceptions.py` | Error hierarchy (11) | `CCFlowError`, `CLITimeoutError`, `SessionNotFoundError` |

### Reliability & Limits
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `reliability.py` | Fault tolerance | `CircuitBreaker`, `retry_with_backoff()`, `HealthChecker` |
| `rate_limiting.py` | Rate/concurrency control | `TokenBucketRateLimiter`, `CombinedLimiter` |
| `pool.py` | Concurrent execution | `ProcessPool`, `StreamingPool` |

### Project & Tracing
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `project.py` | Hierarchical organization | `Project` |
| `tracing.py` | Auto trace recording | `TracingSession`, `create_tracing_session()` |
| `trace_store.py` | Trace/project protocols | `TraceStore`, `ProjectStore` |

### Storage (src/ccflow/stores/)
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `sqlite.py` | SQLite session storage | `SQLiteSessionStore` |
| `traces.py` | SQLite trace/project storage | `SQLiteTraceStore`, `SQLiteProjectStore` |
| `memory.py` | In-memory storage | `MemorySessionStore` |

### Observability
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `events.py` | Event pub/sub (15 types) | `EventEmitter`, `EventType`, `CostTracker` |
| `pricing.py` | Cost calculation | `calculate_cost()`, `ModelPricing`, `UsageStats` |
| `metrics.py` | Prometheus metrics | `record_request()`, `metric_timer()` |
| `metrics_handlers.py` | Event→Prometheus bridge | `PrometheusEventHandler` |

### Features
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `toon_integration.py` | Token optimization | `ToonSerializer` |
| `permissions.py` | CLI permission mapping | `PermissionTranslator` |
| `mcp.py` | MCP server config | `MCPConfigManager` |
| `api_client.py` | API fallback (optional) | `APIClient`, `FallbackExecutor` |

### CLI & Server
| Module | Purpose | Key Exports |
|--------|---------|-------------|
| `cli.py` | Command-line interface | `main()` |
| `server.py` | FastAPI HTTP/WebSocket | `create_app()` |

## Configuration

### CLIAgentOptions (40+ fields)
```python
CLIAgentOptions(
    # Model
    model="sonnet",              # haiku, sonnet, opus
    fallback_model="haiku",      # On overload

    # System prompt
    system_prompt=None,          # Replace system prompt
    append_system_prompt=None,   # Append to system prompt

    # Permissions
    permission_mode=PermissionMode.DEFAULT,
    allowed_tools=["Read", "Edit"],
    disallowed_tools=["Bash(rm:*)"],

    # Session
    session_id=None,             # Specific session UUID
    resume=False,                # Resume previous session

    # Limits
    max_turns=10,
    timeout=300.0,

    # Extended thinking
    ultrathink=False,            # Enable deep reasoning

    # Context
    context={"data": "value"},   # Auto-TOON encoded
    toon=ToonConfig(enabled=True),

    # MCP
    mcp_servers={"github": MCPServerConfig(...)},
)
```

### Environment Variables
| Variable | Description | Default |
|----------|-------------|---------|
| `CCFLOW_DEFAULT_MODEL` | Default model | `sonnet` |
| `CCFLOW_DEFAULT_TIMEOUT` | Timeout (seconds) | `300` |
| `CCFLOW_TOON_ENABLED` | Enable TOON encoding | `true` |
| `CCFLOW_LOG_LEVEL` | Logging level | `INFO` |
| `CCFLOW_ENABLE_METRICS` | Enable Prometheus | `true` |

## Message Types (11)

```python
Message = (
    InitMessage |           # Session initialization
    TextMessage |           # Text content from Claude
    ThinkingMessage |       # Extended thinking content
    ToolUseMessage |        # Tool invocation
    ToolResultMessage |     # Tool execution result
    ErrorMessage |          # Error from CLI
    StopMessage |           # Turn completion with usage
    HookMessage |           # Hook execution result
    AssistantMessage |      # Full assistant response
    UserMessage |           # User message echo
    ResultMessage |         # Final result
    UnknownMessage          # Forward-compatible fallback
)
```

### Common Pattern
```python
async for msg in query("prompt", options):
    if isinstance(msg, TextMessage):
        print(msg.content, end="")
    elif isinstance(msg, ThinkingMessage):
        print(f"[Thinking: {msg.thinking_tokens} tokens]")
    elif isinstance(msg, ToolUseMessage):
        print(f"Tool: {msg.tool}({msg.args})")
    elif isinstance(msg, StopMessage):
        print(f"\nTokens: {msg.usage}")
```

## Data Types

### TraceData
```python
@dataclass
class TraceData:
    trace_id: str
    session_id: str
    project_id: str | None
    sequence_number: int
    prompt: str
    response: str
    thinking: str
    tool_calls: list[dict]
    message_stream: list[dict] | None  # When detailed=True
    input_tokens: int
    output_tokens: int
    thinking_tokens: int
    cost_usd: float
    duration_ms: int
    status: TraceStatus  # pending, success, error, cancelled
```

### ProjectData
```python
@dataclass
class ProjectData:
    project_id: str
    name: str
    description: str
    parent_project_id: str | None  # For nesting
    metadata: dict
    created_at: str
    updated_at: str
```

## Reliability Features

### Rate Limiting
```python
from ccflow import CombinedLimiter

limiter = CombinedLimiter(rate=10.0, max_concurrent=5)
async with limiter.acquire():
    # rate-limited operation
```

### Circuit Breaker
```python
from ccflow import CircuitBreaker, CircuitBreakerConfig

breaker = CircuitBreaker(CircuitBreakerConfig(
    failure_threshold=5,
    recovery_timeout=30.0,
))
async with breaker.call():
    # protected operation
```

### Retry with Backoff
```python
from ccflow import retry_with_backoff, RetryConfig

result = await retry_with_backoff(
    async_func,
    RetryConfig(max_retries=3, base_delay=1.0, exponential=True),
)
```

## Cost Tracking

```python
from ccflow import calculate_cost, get_usage_tracker, ModelTier

# Single calculation
cost = calculate_cost("sonnet", input_tokens=1000, output_tokens=500)
# Returns: $0.0105

# Cumulative tracking
tracker = get_usage_tracker()
tracker.add("sonnet", input_tokens=1000, output_tokens=500)
print(f"Total: ${tracker.total_cost_usd:.4f}")
print(f"By model: {tracker.by_model}")
```

## Events

```python
from ccflow import get_emitter, EventType

emitter = get_emitter()

@emitter.on(EventType.TURN_COMPLETED)
async def on_turn(event):
    print(f"Turn completed: {event.input_tokens} in, {event.output_tokens} out")

@emitter.on(EventType.THINKING_RECEIVED)
async def on_thinking(event):
    print(f"Thinking: {event.thinking_tokens} tokens")
```

## Storage

```python
from ccflow import SQLiteSessionStore, MemorySessionStore
from ccflow.stores import SQLiteTraceStore, SQLiteProjectStore

# Session storage
session_store = SQLiteSessionStore("sessions.db")

# Trace storage
trace_store = SQLiteTraceStore("sessions.db")

# Project storage
project_store = SQLiteProjectStore("sessions.db")

# In-memory (testing)
memory_store = MemorySessionStore()
```

## Exceptions

```
CCFlowError (base)
├── CLINotFoundError         # Claude CLI not installed
├── CLIAuthenticationError   # OAuth not configured
├── CLIExecutionError        # CLI subprocess failed
├── CLITimeoutError          # Operation timed out
├── SessionNotFoundError     # Session doesn't exist
├── ParseError               # NDJSON parsing failed
├── ToonEncodingError        # TOON serialization failed
├── PermissionDeniedError    # Tool permission denied
├── MCPConfigError           # MCP config invalid
├── SessionStoreError        # Storage operation failed
├── CircuitBreakerError      # Circuit is open
├── RateLimitExceededError   # Rate limit hit
└── ConcurrencyLimitExceededError  # Max concurrent reached
```

## CLI Usage

```bash
# Basic query
ccflow "Explain this code"

# With model selection
ccflow -m opus "Review for security"

# Streaming mode
ccflow --stream "Analyze the codebase"

# Session management
ccflow sessions --list
ccflow sessions --resume <session-id>

# Start HTTP server
ccflow server --port 8080
```

## File Structure

```
src/ccflow/
├── __init__.py           # 172 public exports
├── api.py                # query(), batch_query()
├── session.py            # Session class (562 LOC)
├── manager.py            # SessionManager (565 LOC)
├── executor.py           # CLIExecutor (592 LOC)
├── parser.py             # StreamParser, helpers
├── types.py              # 50+ dataclasses/enums (615 LOC)
├── config.py             # CCFlowSettings
├── exceptions.py         # 11 exception classes
├── events.py             # EventEmitter, 15 event types (588 LOC)
├── reliability.py        # CircuitBreaker, retry (766 LOC)
├── rate_limiting.py      # Limiters (744 LOC)
├── pool.py               # ProcessPool (772 LOC)
├── pricing.py            # Cost calculation (414 LOC)
├── project.py            # Project class (460 LOC)
├── tracing.py            # TracingSession
├── trace_store.py        # Store protocols (399 LOC)
├── toon_integration.py   # ToonSerializer
├── permissions.py        # PermissionTranslator
├── mcp.py                # MCPConfigManager
├── api_client.py         # APIClient, FallbackExecutor (624 LOC)
├── metrics.py            # Prometheus metrics
├── metrics_handlers.py   # Event→Prometheus (392 LOC)
├── cli.py                # CLI entry point (611 LOC)
├── server.py             # FastAPI server (741 LOC)
└── stores/
    ├── __init__.py       # Store exports
    ├── sqlite.py         # SQLiteSessionStore
    ├── traces.py         # SQLiteTraceStore, SQLiteProjectStore
    └── memory.py         # MemorySessionStore
```

## Testing

```bash
# Run all tests
pytest tests/ -v

# With coverage
pytest tests/ --cov=ccflow --cov-report=term-missing

# Specific module
pytest tests/test_tracing.py -v

# Skip slow/integration tests
pytest tests/ -m "not slow and not integration"
```

## Docker

```bash
# Build
docker build -t ccflow .

# Run (mount Claude credentials)
docker run -v ~/.claude:/home/ccflow/.claude ccflow

# Docker Compose (with Prometheus/Grafana)
docker compose up
```

## Links

- **API Docs**: docs/api.md
- **Architecture**: docs/architecture.md
- **TOON Spec**: docs/TOON_RESEARCH.md
- **Changelog**: CHANGELOG.md
- **Source**: src/ccflow/
- **Tests**: tests/
